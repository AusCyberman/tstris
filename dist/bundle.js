(()=>{"use strict";var t;!function(t){t[t.Down=0]="Down",t[t.Left=1]="Left",t[t.Up=2]="Up",t[t.Right=3]="Right"}(t||(t={}));class e{constructor(t,e){this.x=t,this.y=e}add(t){return new e(t.x+this.x,t.y+this.y)}scale(t){return new e(this.x*t,this.y*t)}}const i=(t,i)=>new e(t,i);var s;!function(t){t[t.I=0]="I",t[t.J=1]="J",t[t.L=2]="L",t[t.O=3]="O",t[t.S=4]="S",t[t.T=5]="T",t[t.Z=6]="Z"}(s||(s={}));class o extends class{}{constructor(e,o,r,c=10,h=t.Down,a=i(0,0)){super(),this.blockSize=c,this.location=o,this.bottomRHS=r,this.topLHS=a,this.shape=e;const{rotate:l,color:n}=function(e){switch(e){case s.I:return{rotate(e){switch(e){case t.Up:case t.Down:return[i(2,0),i(2,1),i(2,2),i(2,3)];case t.Right:case t.Left:return[i(0,1),i(1,1),i(2,1),i(3,1)]}},color:"cyan"};case s.J:return{rotate(e){switch(e){case t.Down:return[i(0,1),i(0,2),i(1,2),i(2,2)];case t.Up:return[i(0,1),i(1,1),i(2,1),i(2,2)];case t.Left:return[i(1,0),i(2,0),i(1,1),i(1,2)];case t.Right:return[i(1,0),i(1,1),i(0,2),i(1,2)]}},color:"darkblue"};case s.L:return{rotate(e){switch(e){case t.Down:return[i(2,1),i(0,2),i(1,2),i(2,2)];case t.Up:return[i(0,1),i(1,1),i(2,1),i(0,2)];case t.Left:return[i(1,0),i(2,2),i(1,1),i(1,2)];case t.Right:return[i(1,0),i(1,1),i(0,0),i(1,2)]}},color:"orange"};case s.O:return{rotate:t=>[i(0,0),i(0,1),i(1,0),i(1,1)],color:"yellow"};case s.S:return{rotate(e){switch(e){case t.Up:case t.Down:return[i(1,1),i(2,1),i(0,2),i(1,2)];case t.Left:case t.Right:return[i(0,0),i(0,1),i(1,1),i(1,2)]}},color:"green"};case s.T:return{rotate(e){switch(e){case t.Down:return[i(1,1),i(0,2),i(1,2),i(2,2)];case t.Left:return[i(1,0),i(1,1),i(2,1),i(1,2)];case t.Up:return[i(0,1),i(1,1),i(2,1),i(1,2)];case t.Right:return[i(1,0),i(0,1),i(1,1),i(1,2)]}},color:"purple"};case s.Z:return{rotate(e){switch(e){case t.Up:case t.Down:return[i(0,1),i(1,1),i(1,2),i(2,2)];case t.Left:case t.Right:return[i(2,0),i(1,1),i(2,1),i(1,2)]}},color:"red"}}}(this.shape);this.rotateF=l,this.rotate(h,null),this.color=n,this.rotation=h}area(){return 4}rotate(t,e){if(!this.stopped)if(null!=e){let i=this.rotateF(t);switch(this.validate(this.construct_coords(i),e)){case"valid":this.shape_vec=i,this.rotation=t;break;case"stop":this.stopped=!0}}else this.rotation=t,this.shape_vec=this.rotateF(t)}validate(t,e){let i=!1;for(const s of t){if((s.x>=(this.topLHS.x+this.bottomRHS.x)/this.blockSize||s.x<0)&&(i=!0),(this.bottomRHS.y-this.topLHS.y)/this.blockSize<=s.y)return"stop";if(null!=e[s.y][s.x]&&(i=!0,this.construct_coords().some((t=>t.y<s.y&&t.x==s.x))))return"stop"}return i?"block":"valid"}construct_coords(t=this.shape_vec,e=this.location){return t.map((t=>i(t.x,t.y).add(e)))}move(e,s){let o=i(this.location.x,this.location.y);if(!this.stopped){switch(e){case t.Left:o.x-=1;break;case t.Right:o.x+=1;break;case t.Down:o.y+=1}switch(this.validate(this.construct_coords(this.shape_vec,o),s)){case"valid":return void(this.location=o);case"stop":this.stopped=!0}}}draw(t){t.save(),t.fillStyle=this.color,t.strokeStyle="black",this.construct_coords().forEach((e=>{let i=e.scale(this.blockSize).add(this.topLHS);t.beginPath(),t.rect(i.x,i.y,this.blockSize,this.blockSize),t.fill(),t.stroke()})),t.restore()}}class r{constructor(t,e,s,o=i(0,0),r=10){this.level=0,this.clearedLines=0,this.blockSize=r,this.canHold=!0,this.gameBottomRHS=e,this.startingGame=o,this.width=e.x-this.startingGame.x,this.height=e.y-this.startingGame.y,this.blockMap=Array.from({length:this.height/r},(()=>Array(this.width/r).fill(null))),this.entireCanvasBottomRHS=s,this.id="gameCanvas",this.ctx=t,this.score=0;let c=this;this.upcoming=Array.from({length:4},(()=>c.makeRandomShape()))}randomSpawnLocation(){return i(Math.floor(Math.random()*((this.gameBottomRHS.x-4*this.blockSize)/this.blockSize)),0)}makeRandomShape(t=i(0,0)){return new o(Math.floor(Math.random()*s.Z),t,this.gameBottomRHS,this.blockSize)}checkScore(){let t=0;this.blockMap.forEach(((e,i)=>{e.every((t=>null!=t))&&(this.blockMap.splice(i,1),t++,this.blockMap.unshift(Array(this.width).fill(null)))})),this.level=Math.floor(this.clearedLines/10),console.log(t,this.clearedLines),console.log(this.level);const e=t=>t*(this.level+1);switch(t){case 1:this.score+=e(40);break;case 2:this.score+=e(100);break;case 3:this.score+=e(300);break;case 4:this.score+=e(1200)}this.clearedLines+=t}drawGrid(){this.ctx.save();let t=this.ctx,e=this.blockSize,i=Math.floor((this.width+2*this.blockSize)/e)-2,s=Math.floor((this.height+2*this.blockSize)/e)-2,o=this.width-i*e,r=this.height-s*e,c=Math.ceil(o/2)-.5,h=Math.ceil(r/2)-.5,a=this.width-i*e-c,l=this.height-s*e-h;t.strokeStyle="lightgrey",t.beginPath();for(var n=c;n<=this.width-a;n+=e)t.moveTo(n,h),t.lineTo(n,this.height-l);for(var d=h;d<=this.height-l;d+=e)t.moveTo(c,d),t.lineTo(this.width-a,d);t.stroke(),this.ctx.restore()}move(t){null!=this.currentBlock&&this.currentBlock.move(t,this.blockMap)}rotate(){this.currentBlock.rotation<3?this.currentBlock.rotate(this.currentBlock.rotation+1,this.blockMap):this.currentBlock.rotate(0,this.blockMap)}drawScore(){this.ctx.save();let t=this.width+2*this.blockSize;this.ctx.beginPath(),this.ctx.font="50px ",this.ctx.fillStyle="blue",this.ctx.fillText("Level: "+this.level,t,10),this.ctx.fillText("Score: "+this.score,t,20,80),this.ctx.restore()}drawUpcomingAndHeld(){let t=this.width+2*this.blockSize,e=this.ctx;e.beginPath(),e.fillStyle="Black",e.fillText("Held ",t,60,90),null!=this.held&&(this.held.location=i(t/this.blockSize,60/this.blockSize+1),this.held.draw(this.ctx)),e.fillText("Upcoming ",t,70+6*this.blockSize),this.upcoming.forEach(((s,o)=>{s.location=i(t/this.blockSize,60/this.blockSize+7+5*o),s.draw(e)}))}drawShadow(){if(null!=this.currentBlock){for(var e=(i=this.currentBlock,Object.assign(Object.create(Object.getPrototypeOf(i)),i));1!=e.stopped;)e.move(t.Down,this.blockMap);e.color="grey",e.draw(this.ctx)}var i}draw(){this.ctx.clearRect(this.startingGame.x,this.startingGame.y,this.width+2,this.height+2),this.ctx.beginPath(),this.ctx.clearRect(this.width+20,0,10*this.blockSize,80*this.blockSize),this.ctx.beginPath(),this.drawScore(),this.drawUpcomingAndHeld(),this.drawShadow(),this.drawGrid(),null!=this.currentBlock&&this.currentBlock.draw(this.ctx),this.blockMap.forEach(((t,e)=>{t.forEach(((t,i)=>{null!=t&&(this.ctx.save(),this.ctx.beginPath(),this.ctx.fillStyle=t,this.ctx.strokeStyle="black",this.ctx.rect(i*this.blockSize+this.startingGame.x,e*this.blockSize+this.startingGame.y,this.blockSize,this.blockSize),this.ctx.stroke(),this.ctx.fill(),this.ctx.restore())}))}))}}function c(t){if(null==t.currentBlock&&(t.canHold=!0,t.currentBlock=t.upcoming.shift(),t.currentBlock.location=t.randomSpawnLocation(),t.upcoming.push(t.makeRandomShape())),t.currentBlock.stopped){for(const e of t.currentBlock.construct_coords()){if(e.y<=0)return t.ctx.fillStyle="red",t.ctx.font="30px Bold",void t.ctx.fillText("GAME OVER",(t.startingGame.x+t.width)/2-60,t.startingGame.y+(t.height/2-40));t.blockMap[e.y][e.x]=t.currentBlock.color}t.checkScore(),t.currentBlock=null}t.draw(),window.requestAnimationFrame((()=>c(t)))}document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("canvas").getContext("2d"),s=new r(e,i(280,600),i(800,800),i(0,0),20);window.setInterval((()=>{null!=s.currentBlock&&s.currentBlock.move(t.Down,s.blockMap)}),1e3),document.addEventListener("keydown",(e=>{switch(e.key){case"ArrowRight":s.move(t.Right);break;case"ArrowLeft":s.move(t.Left);break;case"ArrowDown":s.move(t.Down);break;case"ArrowUp":s.rotate();break;case" ":for(;1!=s.currentBlock.stopped;)s.move(t.Down);break;case"c":s.canHold&&(null==s.held&&(s.held=s.upcoming.pop(),s.upcoming.push(s.makeRandomShape())),[s.held,s.currentBlock]=[s.currentBlock,s.held],s.currentBlock.location=s.randomSpawnLocation(),s.canHold=!1)}})),window.requestAnimationFrame((()=>c(s)))}))})();