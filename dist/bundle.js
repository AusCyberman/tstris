(()=>{"use strict";var t;!function(t){t[t.Down=0]="Down",t[t.Left=1]="Left",t[t.Up=2]="Up",t[t.Right=3]="Right"}(t||(t={})),Map;class e{constructor(t,e){this.x=t,this.y=e}add(t){return new e(t.x+this.x,t.y+this.y)}scale(t){return new e(this.x*t,this.y*t)}toTuple(){return[this.x,this.y]}}const o=(t,o)=>new e(t,o);var i;!function(t){t[t.I=0]="I",t[t.J=1]="J",t[t.L=2]="L",t[t.O=3]="O",t[t.S=4]="S",t[t.T=5]="T",t[t.Z=6]="Z"}(i||(i={}));class s extends class{}{constructor(e,s,c,r=10,h=t.Down,a=o(0,0)){super(),this.blockSize=r,this.location=s,this.bottomRHS=c,this.topLHS=a,this.shape=e;const{rotate:l,color:n}=function(e){switch(e){case i.I:return{rotate(e){switch(e){case t.Up:case t.Down:return[o(2,0),o(2,1),o(2,2),o(2,3)];case t.Right:case t.Left:return[o(0,1),o(1,1),o(2,1),o(3,1)]}},color:"cyan"};case i.J:return{rotate(e){switch(e){case t.Down:return[o(0,1),o(0,2),o(1,2),o(2,2)];case t.Up:return[o(0,1),o(1,1),o(2,1),o(2,2)];case t.Left:return[o(1,0),o(2,0),o(1,1),o(1,2)];case t.Right:return[o(1,0),o(1,1),o(0,2),o(1,2)]}},color:"darkblue"};case i.L:return{rotate(e){switch(e){case t.Down:return[o(2,1),o(0,2),o(1,2),o(2,2)];case t.Up:return[o(0,1),o(1,1),o(2,1),o(0,2)];case t.Left:return[o(1,0),o(2,2),o(1,1),o(1,2)];case t.Right:return[o(1,0),o(1,1),o(0,0),o(1,2)]}},color:"orange"};case i.O:return{rotate:t=>[o(0,0),o(0,1),o(1,0),o(1,1)],color:"yellow"};case i.S:return{rotate(e){switch(e){case t.Up:case t.Down:return[o(1,1),o(2,1),o(0,2),o(1,2)];case t.Left:case t.Right:return[o(0,0),o(0,1),o(1,1),o(1,2)]}},color:"green"};case i.T:return{rotate(e){switch(e){case t.Down:return[o(1,1),o(0,2),o(1,2),o(2,2)];case t.Left:return[o(1,0),o(1,1),o(2,1),o(1,2)];case t.Up:return[o(0,1),o(1,1),o(2,1),o(1,2)];case t.Right:return[o(1,0),o(0,1),o(1,1),o(1,2)]}},color:"purple"};case i.Z:return{rotate(e){switch(e){case t.Up:case t.Down:return[o(0,1),o(1,1),o(1,2),o(2,2)];case t.Left:case t.Right:return[o(2,0),o(1,1),o(2,1),o(1,2)]}},color:"red"}}}(this.shape);this.rotateF=l,this.rotate(h,null),this.color=n,this.rotation=h}area(){return 4}rotate(t,e){if(!this.stopped)if(null!=e){let o=this.rotateF(t);switch(this.validate(this.construct_coords(o),e)){case"valid":this.shape_vec=o,this.rotation=t;break;case"stop":this.stopped=!0}}else this.rotation=t,this.shape_vec=this.rotateF(t)}validate(t,e){let o=!1;for(const i of t){if((i.x>=(this.topLHS.x+this.bottomRHS.x)/this.blockSize||i.x<0)&&(console.log(i.x),o=!0),console.log("B VALUES ARE: ",i.x,i.y),console.log("TOTAL SIZE: ",(this.bottomRHS.y-this.topLHS.y)/this.blockSize),console.log("MAP SIZE: ",e.length),(this.bottomRHS.y-this.topLHS.y)/this.blockSize<=i.y)return console.log("its out"),"stop";if(null!=e[i.y][i.x]&&(console.log("has"),o=!0,this.construct_coords().some((t=>t.y<i.y&&t.x==i.x))))return"stop"}return o?"block":"valid"}construct_coords(t=this.shape_vec,e=this.location){return t.map((t=>o(t.x,t.y).add(e)))}move(e,i){let s=o(this.location.x,this.location.y);if(!this.stopped){switch(e){case t.Left:s.x-=1;break;case t.Right:s.x+=1;break;case t.Down:s.y+=1}const o=this.validate(this.construct_coords(this.shape_vec,s),i);switch(console.log(o),o){case"valid":return void(this.location=s);case"stop":this.stopped=!0;break;case"block":console.log("nothing")}}}draw(t){console.log("X is: "+this.location.x),t.save(),t.fillStyle=this.color,t.strokeStyle="black",this.construct_coords().forEach((e=>{let o=e.scale(this.blockSize).add(this.topLHS);t.beginPath(),console.log(o),t.rect(o.x,o.y,this.blockSize,this.blockSize),t.fill(),t.stroke()})),t.restore()}}class c{constructor(t,e,i,s=o(0,0),c=10){this.blockSize=c,this.canHold=!0,this.gameBottomRHS=e,this.startingGame=s,this.width=e.x-this.startingGame.x,this.height=e.y-this.startingGame.y,this.blockMap=Array.from({length:this.height/c},(()=>Array(this.width/c).fill(null))),this.entireCanvasBottomRHS=i,this.id="gameCanvas",this.ctx=t,this.score=0;let r=this;this.upcoming=Array.from({length:4},(()=>r.makeRandomShape()))}randomSpawnLocation(){let t=o(Math.floor(Math.random()*((this.gameBottomRHS.x-4*this.blockSize)/this.blockSize)),0);return console.log("Val is",t,"Block size is: ",this.blockSize),t}makeRandomShape(t=o(0,0)){return new s(Math.floor(Math.random()*i.Z),t,this.gameBottomRHS,this.blockSize)}checkScore(){this.blockMap.forEach(((t,e)=>{t.every((t=>null!=t))&&(this.blockMap.splice(e,1),this.score++,this.blockMap.unshift(Array(this.width).fill(null)))}))}drawGrid(){this.ctx.save();let t=this.ctx,e=this.blockSize,o=Math.floor((this.width+2*this.blockSize)/e)-2,i=Math.floor((this.height+2*this.blockSize)/e)-2,s=this.width-o*e,c=this.height-i*e,r=Math.ceil(s/2)-.5,h=Math.ceil(c/2)-.5,a=this.width-o*e-r,l=this.height-i*e-h;t.strokeStyle="lightgrey",t.beginPath();for(var n=r;n<=this.width-a;n+=e)t.moveTo(n,h),t.lineTo(n,this.height-l);for(var u=h;u<=this.height-l;u+=e)t.moveTo(r,u),t.lineTo(this.width-a,u);t.stroke(),this.ctx.restore()}move(t){null!=this.currentBlock&&this.currentBlock.move(t,this.blockMap)}rotate(){this.currentBlock.rotation<3?this.currentBlock.rotate(this.currentBlock.rotation+1,this.blockMap):this.currentBlock.rotate(0,this.blockMap)}drawScore(){this.ctx.save();let t=this.width+2*this.blockSize;this.ctx.beginPath(),this.ctx.font="50px ",this.ctx.fillStyle="blue",this.ctx.fillText("Score: "+this.score,t,10,80),this.ctx.restore()}drawUpcomingAndHeld(){let t=this.width+2*this.blockSize,e=this.ctx;e.beginPath(),e.fillStyle="Black",e.fillText("Held ",t,60,90),null!=this.held&&(this.held.location=o(t/this.blockSize,60/this.blockSize+1),this.held.draw(this.ctx)),e.fillText("Upcoming ",t,70+6*this.blockSize),this.upcoming.forEach(((i,s)=>{i.location=o(t/this.blockSize,60/this.blockSize+7+5*s),i.draw(e)}))}drawShadow(){if(null!=this.currentBlock){for(var e=Object.assign(Object.create(Object.getPrototypeOf(this.currentBlock)),this.currentBlock);1!=e.stopped;)e.move(t.Down,this.blockMap);e.color="grey",e.draw(this.ctx)}}draw(){this.ctx.clearRect(this.startingGame.x,this.startingGame.y,this.width+2,this.height+2),this.ctx.beginPath(),this.ctx.clearRect(this.width+20,0,10*this.blockSize,80*this.blockSize),this.ctx.beginPath(),this.drawScore(),this.drawUpcomingAndHeld(),this.drawShadow(),this.drawGrid(),null!=this.currentBlock&&this.currentBlock.draw(this.ctx),this.blockMap.forEach(((t,e)=>{t.forEach(((t,o)=>{null!=t&&(this.ctx.save(),this.ctx.beginPath(),this.ctx.fillStyle=t,this.ctx.strokeStyle="black",this.ctx.rect(o*this.blockSize+this.startingGame.x,e*this.blockSize+this.startingGame.y,this.blockSize,this.blockSize),this.ctx.stroke(),this.ctx.fill(),this.ctx.restore())}))}))}}function r(t){if(null==t.currentBlock&&(t.canHold=!0,t.currentBlock=t.upcoming.shift(),t.currentBlock.location=t.randomSpawnLocation(),t.upcoming.push(t.makeRandomShape())),t.currentBlock.stopped){for(const e of t.currentBlock.construct_coords()){if(console.log(t.blockMap),console.log(e.y,e.x),e.y<=0)return t.ctx.fillStyle="red",t.ctx.font="30px Bold",void t.ctx.fillText("GAME OVER",(t.startingGame.x+t.width)/2-60,t.startingGame.y+(t.height/2-40));t.blockMap[e.y][e.x]=t.currentBlock.color}t.checkScore(),t.currentBlock=null}t.draw(),window.requestAnimationFrame((()=>r(t)))}document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("canvas").getContext("2d"),i=new c(e,o(280,600),o(800,800),o(0,0),20);window.setInterval((()=>{null!=i.currentBlock&&i.currentBlock.move(t.Down,i.blockMap)}),1e3),document.addEventListener("keydown",(e=>{switch(e.key){case"ArrowRight":i.move(t.Right);break;case"ArrowLeft":i.move(t.Left);break;case"ArrowDown":i.move(t.Down);break;case"ArrowUp":i.rotate();break;case" ":for(;1!=i.currentBlock.stopped;)i.move(t.Down);break;case"c":i.canHold&&(null==i.held&&(i.held=i.upcoming.pop(),i.upcoming.push(i.makeRandomShape())),[i.held,i.currentBlock]=[i.currentBlock,i.held],i.currentBlock.location=i.randomSpawnLocation(),i.canHold=!1)}})),window.requestAnimationFrame((()=>r(i)))}))})();